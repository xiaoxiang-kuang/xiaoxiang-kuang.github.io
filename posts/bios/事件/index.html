<!DOCTYPE html>
<html dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark">

<title>事件 | 小象的blog</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e24d94cf619e7e6705439036ee43e77f243d24ac89100b59375379bc4d659d87.css" >
  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" ></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">

    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>小象的blog</span>
  </a>
</h2>


















  
<ul>
  
  <li>
    <a href="/posts/">
        主页
      </a>
  </li>
  
  <li>
    <a href="/posts/linux/linux%E5%91%BD%E4%BB%A4/">
        linux命令总结
      </a>
  </li>
  
  <li>
    <a href="/posts/linux/shell%E8%84%9A%E6%9C%AC/">
        shell脚本
      </a>
  </li>
  
  <li>
    <a href="/categories/book/">
        书籍笔记
      </a>
  </li>
  
  <li>
    <a href="/about/">
        关于
      </a>
  </li>
  
</ul>





</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


  <div class="split-line"></div>
  
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#事件函数">事件函数</a>
          <ul>
            <li><a href="#waitforevent-等待事件发生">WaitForEvent 等待事件发生</a></li>
            <li><a href="#createevent-创建事件">CreateEvent 创建事件</a></li>
            <li><a href="#createeventex">CreateEventEx</a></li>
            <li><a href="#checkevent-检查事件状态">CheckEvent 检查事件状态</a></li>
            <li><a href="#signalevent-触发事件">SignalEvent 触发事件</a></li>
            <li><a href="#closeevent-关闭事件">CloseEvent 关闭事件</a></li>
            <li><a href="#settimer">SetTimer</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>

    <div class="book-page">
      <div>
	      <header class="book-header">
          
  <div class="flex align-center justify-between">
   <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
  
  <strong>事件</strong>
</div>


  
    <aside class="hidden clearfix">
      <nav>
        




        








        

  
<ul>
  
  <li>
    <a href="/posts/">
        主页
      </a>
  </li>
  
  <li>
    <a href="/posts/linux/linux%E5%91%BD%E4%BB%A4/">
        linux命令总结
      </a>
  </li>
  
  <li>
    <a href="/posts/linux/shell%E8%84%9A%E6%9C%AC/">
        shell脚本
      </a>
  </li>
  
  <li>
    <a href="/categories/book/">
        书籍笔记
      </a>
  </li>
  
  <li>
    <a href="/about/">
        关于
      </a>
  </li>
  
</ul>





      </nav>
      <div class="split-line"></div>
      
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#事件函数">事件函数</a>
          <ul>
            <li><a href="#waitforevent-等待事件发生">WaitForEvent 等待事件发生</a></li>
            <li><a href="#createevent-创建事件">CreateEvent 创建事件</a></li>
            <li><a href="#createeventex">CreateEventEx</a></li>
            <li><a href="#checkevent-检查事件状态">CheckEvent 检查事件状态</a></li>
            <li><a href="#signalevent-触发事件">SignalEvent 触发事件</a></li>
            <li><a href="#closeevent-关闭事件">CloseEvent 关闭事件</a></li>
            <li><a href="#settimer">SetTimer</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
        </header>
        
<article class="markdown">
  <h1>
    <a href="/posts/bios/%E4%BA%8B%E4%BB%B6/">事件</a>
  </h1>
  
  <h5>2023-07-25</h5>



  

  
  <div>
    
      <a href="/tags/bios/">bios</a>
  </div>
  



<ul>
<li>UEFI的所有异步操作需要通过事件来完成。</li>
</ul>
<h2 id="事件函数">
  事件函数
  <a class="anchor" href="#%e4%ba%8b%e4%bb%b6%e5%87%bd%e6%95%b0">#</a>
</h2>
<h3 id="waitforevent-等待事件发生">
  WaitForEvent 等待事件发生
  <a class="anchor" href="#waitforevent-%e7%ad%89%e5%be%85%e4%ba%8b%e4%bb%b6%e5%8f%91%e7%94%9f">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_SUCCESS           The event indicated by Index was signaled.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_INVALID_PARAMETER 1. NumberOfEvents is 0; 2. The event indicated by Index is of type EVT_NOTIFY_SIGNAL.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_UNSUPPORTED       The current TPL is not TPL_APPLICATION.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_WAIT_FOR_EVENT)(
</span></span><span style="display:flex;"><span>  IN  UINTN                    NumberOfEvents,  <span style="color:#75715e">//event数组的长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  EFI_EVENT                <span style="color:#f92672">*</span>Event,  <span style="color:#75715e">//event数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  OUT UINTN                    <span style="color:#f92672">*</span>Index   <span style="color:#75715e">//返回触发事件的下标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  );
</span></span></code></pre></div><ul>
<li>WaitForEvent是<strong>阻塞操作</strong>，直到Event数组内任一事件被触发或者事件导致错误出现时，WaitForEvent才返回。</li>
<li>事件触发后返回index，并将事件重置为非触发状态。</li>
<li>EVT_NOTIFY_SIGNAL类型的事件似乎不能用WaitForEvent。</li>
</ul>
<h3 id="createevent-创建事件">
  CreateEvent 创建事件
  <a class="anchor" href="#createevent-%e5%88%9b%e5%bb%ba%e4%ba%8b%e4%bb%b6">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_SUCCESS           The event structure was created.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_INVALID_PARAMETER One or more parameters are invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_OUT_OF_RESOURCES  The event could not be allocated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_CREATE_EVENT)(
</span></span><span style="display:flex;"><span>  IN  UINT32                       Type,    <span style="color:#75715e">//事件类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  EFI_TPL                      NotifyTpl,   <span style="color:#75715e">//Notification函数的优先级
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  EFI_EVENT_NOTIFY             NotifyFunction,  <span style="color:#75715e">//Notification函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  VOID                         <span style="color:#f92672">*</span>NotifyContext,  <span style="color:#75715e">//传给Notification函数的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  OUT EFI_EVENT                    <span style="color:#f92672">*</span>Event   <span style="color:#75715e">//生成的事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  );
</span></span></code></pre></div><h4 id="事件类型">
  事件类型
  <a class="anchor" href="#%e4%ba%8b%e4%bb%b6%e7%b1%bb%e5%9e%8b">#</a>
</h4>
<ul>
<li>事件类型可以是一种或多种基本类型的组合。常用的事件类型如下：</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>特征</th>
</tr>
</thead>
<tbody>
<tr>
<td>EVT_TIMER</td>
<td>定时器事件，没有Notification函数，生成事件后需要调用setTimer服务设置时钟属性。事件可以通过SetTimer设置等待事件、到期后通过SignalEvent触发、通过WaitForEvent等待事件触发、通过CheckEvent检查事件</td>
</tr>
<tr>
<td>EVT_NOTIFY_WAIT</td>
<td>有一个Notification函数，当调用CheckEvent或WaitForEvent时，Notifyication函数会被放到待执行队列</td>
</tr>
<tr>
<td>EVT_NOTIFY_SIGNAL</td>
<td>有一个Notification函数，当前事件通过SignalEvent被触发时，这个Notification函数会被放到待执行队列</td>
</tr>
<tr>
<td>0X00000000</td>
<td>没有Notification函数，事件可以通过signalevent触发、waitforevent等待事件被触发、checkevent检查状态</td>
</tr>
</tbody>
</table>
<ul>
<li>还有两种特殊的事件
<ul>
<li>EVT_SIGNAL_EXIT_BOOT_SERVICES：当ExitBootServices被执行时，事件被触发。</li>
<li>EVT_SIGNAL_VIRTUAL_ADDRESS_CHANGE：当SetVirtualAddressMap被调用时触发此类型的事件。</li>
</ul>
</li>
</ul>
<h4 id="优先级">
  优先级
  <a class="anchor" href="#%e4%bc%98%e5%85%88%e7%ba%a7">#</a>
</h4>
<ul>
<li>有四个预定义的优先级</li>
</ul>
<table>
<thead>
<tr>
<th>优先级</th>
<th>用法</th>
<th>函数</th>
</tr>
</thead>
<tbody>
<tr>
<td>TPL_APPLICATION</td>
<td>优先级最低，当程序运行在此级别时，任务队列中没有任何处于就绪状态的Notification函数</td>
<td>下列安徽念书运行在此级别ExitBootServices()、WaitForEvent()等</td>
</tr>
<tr>
<td>TPL_CALLBACK</td>
<td>比较耗时的操作通常在这个优先级</td>
<td>Serial I/O Protocol、UnloadImage</td>
</tr>
<tr>
<td>TPL_NOTIFY</td>
<td>运行在这个级别的程序不允许阻塞，大部分Event的Notification函数允许在这个级别</td>
<td>Memory Allocation Services、HII Protocols</td>
</tr>
<tr>
<td>TPL_HIGH_LEVEL</td>
<td>UEFI内核全局变量的修改允许在这个级别</td>
<td>SignalEvent、stall</td>
</tr>
</tbody>
</table>
<h4 id="notification函数">
  Notification函数
  <a class="anchor" href="#notification%e5%87%bd%e6%95%b0">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">VOID</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_EVENT_NOTIFY)(
</span></span><span style="display:flex;"><span>  IN  EFI_EVENT                Event,   <span style="color:#75715e">//拥有此函数的事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  VOID                     <span style="color:#f92672">*</span>Context <span style="color:#75715e">//上下文指针，在CreateEvent设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  );
</span></span></code></pre></div><ul>
<li>根据上面的事件类型可知，EVT_NOTIFY_WAIT的函数会在等待事件的过程中调用，而EVT_NOTIFY_SIGNAL的Notification函数会在SignalEvent调用。</li>
</ul>
<h3 id="createeventex">
  CreateEventEx
  <a class="anchor" href="#createeventex">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_SUCCESS           The event structure was created.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_INVALID_PARAMETER One or more parameters are invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_OUT_OF_RESOURCES  The event could not be allocated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_CREATE_EVENT_EX)(
</span></span><span style="display:flex;"><span>  IN       UINT32                 Type,
</span></span><span style="display:flex;"><span>  IN       EFI_TPL                NotifyTpl,
</span></span><span style="display:flex;"><span>  IN       EFI_EVENT_NOTIFY       NotifyFunction OPTIONAL,
</span></span><span style="display:flex;"><span>  IN CONST VOID                   <span style="color:#f92672">*</span>NotifyContext OPTIONAL,
</span></span><span style="display:flex;"><span>  IN CONST EFI_GUID               <span style="color:#f92672">*</span>EventGroup    OPTIONAL,  <span style="color:#75715e">//事件组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  OUT      EFI_EVENT              <span style="color:#f92672">*</span>Event
</span></span><span style="display:flex;"><span>  );
</span></span></code></pre></div><ul>
<li>CreateEventEx用于生成事件并将事件加入事件组。当事件组中的任意事件被触发后，组中的所有事件都会被触发，进而组内所有的Notification函数都会被加入待执行队列，组内优先级最高的Notification函数会被先执行。</li>
<li>存在四个预定义的Event组：
<ul>
<li>EFI_EVENT_GROUP_EXIT_BOOT_SERVICES：当执行ExitBootServices触发组内所有的事件。</li>
<li>EFI_EVENT_GROUP_VIRTUAL_ADDRESS_CHANGE：当执行SetVirtualAddressMap触发组内所有的Event。</li>
<li>EFI_EVENT_GROUP_MEMORY_MAP_CHANGE：Memory Map改变时触发组内所有的Event。</li>
<li>EFI_EVENT_GROUP_READY_TO_BOOT：Boot Manager加载并且执行一个启动项时触发组内所有的Event。</li>
</ul>
</li>
</ul>
<h3 id="checkevent-检查事件状态">
  CheckEvent 检查事件状态
  <a class="anchor" href="#checkevent-%e6%a3%80%e6%9f%a5%e4%ba%8b%e4%bb%b6%e7%8a%b6%e6%80%81">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_SUCCESS           事件是触发态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_NOT_READY         事件是非触发态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_INVALID_PARAMETER 事件类型是EVT_NOTIFY_SIGNAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_CHECK_EVENT)(
</span></span><span style="display:flex;"><span>  IN EFI_EVENT                Event
</span></span><span style="display:flex;"><span>  );
</span></span></code></pre></div><h3 id="signalevent-触发事件">
  SignalEvent 触发事件
  <a class="anchor" href="#signalevent-%e8%a7%a6%e5%8f%91%e4%ba%8b%e4%bb%b6">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_SIGNAL_EVENT)(
</span></span><span style="display:flex;"><span>  IN  EFI_EVENT                Event
</span></span><span style="display:flex;"><span>  );
</span></span></code></pre></div><ul>
<li>将事件设置为触发态。如果该事件在一个组中，则将族中所有的事件设置为触发态。</li>
</ul>
<h3 id="closeevent-关闭事件">
  CloseEvent 关闭事件
  <a class="anchor" href="#closeevent-%e5%85%b3%e9%97%ad%e4%ba%8b%e4%bb%b6">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_CLOSE_EVENT)(
</span></span><span style="display:flex;"><span>  IN EFI_EVENT                Event
</span></span><span style="display:flex;"><span>  );
</span></span></code></pre></div><h3 id="settimer">
  SetTimer
  <a class="anchor" href="#settimer">#</a>
</h3>
<ul>
<li>EVT_TIMER是一类特殊的事件，可以通过SetTimer服务设置定时器属性。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_SUCCESS           The event has been set to be signaled at the requested time.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  @retval EFI_INVALID_PARAMETER Event or Type is not valid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EFI_STATUS</span>
</span></span><span style="display:flex;"><span>(EFIAPI <span style="color:#f92672">*</span>EFI_SET_TIMER)(
</span></span><span style="display:flex;"><span>  IN  EFI_EVENT                Event,
</span></span><span style="display:flex;"><span>  IN  EFI_TIMER_DELAY          Type,    <span style="color:#75715e">//定时器类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IN  UINT64                   TriggerTime  <span style="color:#75715e">//过期事件，100ns为一个单位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  );
</span></span></code></pre></div><ul>
<li>定时器类型如下：</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>TimerCancel</td>
<td>取消定时器触发</td>
</tr>
<tr>
<td>TimerPeriodic</td>
<td>重复型定时器</td>
</tr>
<tr>
<td>TimerRelative</td>
<td>一次性定时器</td>
</tr>
</tbody>
</table>
<ul>
<li>如果Type为TimerPeriodic并且TriggerTIme是0，则定时器每个时钟滴答触发一次。</li>
<li>生成定时器事件包含两步：
<ol>
<li>通过CreateEvent生成一个EVT_TIMER事件</li>
<li>通过SetTimer设置这个定时器事件的属性。</li>
</ol>
</li>
</ul></article>
 
	    </div>

      <footer class="page-footer">
        
  


 
      </footer>
    </div>

  </main>

</body>
</html>











